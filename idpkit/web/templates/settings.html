{% extends "base.html" %}
{% block title %}Settings - IDP Kit{% endblock %}
{% block content %}
<div class="page-header">
    <h2><i class="fas fa-cog"></i> Settings</h2>
</div>
<div x-data="settingsPage()" x-init="loadSettings()">
    <div class="settings-grid">
        <div class="settings-card">
            <h3><i class="fas fa-user"></i> Profile</h3>
            <div class="form-group">
                <label>Username</label>
                <input type="text" :value="user.username" disabled>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="text" :value="user.email || 'Not set'" disabled>
            </div>
            <div class="form-group">
                <label>Role</label>
                <span class="badge" x-text="user.role"></span>
            </div>
        </div>
        <div class="settings-card">
            <h3><i class="fas fa-key"></i> API Key</h3>
            <p>Use this key to access IDP Kit API programmatically.</p>
            <div class="api-key-display" x-show="apiKey">
                <code x-text="apiKey"></code>
                <button @click="navigator.clipboard.writeText(apiKey)" class="btn btn-sm"><i class="fas fa-copy"></i></button>
            </div>
            <button @click="generateKey()" class="btn btn-primary">
                <i class="fas fa-sync"></i> Generate New API Key
            </button>
        </div>
        <div class="settings-card">
            <h3><i class="fas fa-brain"></i> LLM Settings</h3>

            <!-- Provider selection -->
            <div class="form-group">
                <label>Provider</label>
                <select x-model="selectedProvider" @change="onProviderChange()">
                    <option value="">-- Select Provider --</option>
                    <template x-for="p in providers" :key="p.id">
                        <option :value="p.id" x-text="p.name + (p.configured ? '' : ' (not configured)')"></option>
                    </template>
                </select>
                <div x-show="loadingProviders" style="margin-top:4px;font-size:.8rem;color:var(--text-muted);">
                    <i class="fas fa-spinner fa-spin"></i> Loading providers...
                </div>
            </div>

            <!-- Model selection -->
            <div class="form-group">
                <label>Default Model
                    <span x-show="models.length > 0" style="font-weight:400;color:var(--text-muted);">
                        (<span x-text="models.length"></span> available)
                    </span>
                </label>

                <!-- Search filter (shown when many models) -->
                <div x-show="models.length > 10" class="doc-search" style="margin-bottom:6px;">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" x-model="modelSearch" placeholder="Filter models...">
                </div>

                <div x-show="loadingModels" style="padding:10px;font-size:.85rem;color:var(--text-muted);">
                    <i class="fas fa-spinner fa-spin"></i> Fetching models from <span x-text="selectedProvider"></span>...
                </div>

                <div x-show="!loadingModels && selectedProvider && models.length > 0"
                    style="max-height:220px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg-white);">
                    <template x-for="m in getFilteredModels()" :key="m.id">
                        <div @click="selectModel(m)"
                            style="padding:8px 14px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border-light);transition:background .15s;"
                            :style="defaultModel === m.id ? 'background:var(--primary-light);font-weight:600;' : ''"
                            @mouseenter="$el.style.background = defaultModel === m.id ? 'var(--primary-light)' : 'var(--border-light)'"
                            @mouseleave="$el.style.background = defaultModel === m.id ? 'var(--primary-light)' : ''">
                            <span style="font-size:.85rem;" x-text="m.name"></span>
                            <span x-show="defaultModel === m.id" style="color:var(--primary);font-size:.8rem;">
                                <i class="fas fa-check"></i>
                            </span>
                        </div>
                    </template>
                    <div x-show="getFilteredModels().length === 0"
                        style="padding:12px;text-align:center;color:var(--text-muted);font-size:.85rem;">
                        No models match filter
                    </div>
                </div>

                <div x-show="!loadingModels && selectedProvider && models.length === 0"
                    style="padding:10px;font-size:.85rem;color:var(--warning);">
                    <i class="fas fa-exclamation-triangle"></i> No models found for this provider
                </div>

                <div x-show="!selectedProvider"
                    style="padding:10px;font-size:.85rem;color:var(--text-muted);">
                    Select a provider above to see available models
                </div>

                <div x-show="defaultModel" style="margin-top:8px;font-size:0.82rem;color:var(--text-secondary);">
                    <i class="fas fa-microchip" style="color:var(--primary);"></i>
                    Selected: <strong x-text="defaultModel"></strong>
                </div>
            </div>

            <p class="hint">Model can also be set per-request via API.</p>
        </div>
        <div class="settings-card">
            <h3><i class="fas fa-info-circle"></i> About</h3>
            <p><strong>IDP Kit</strong> v<span x-text="version"></span></p>
            <p>Intelligent Document Processing Toolkit & AI Agent</p>
            <p>Powered by PageIndex vectorless RAG engine + LiteLLM</p>
        </div>
    </div>
</div>
<script>
function settingsPage() {
    return {
        user: {}, apiKey: '', version: '2.0.0',
        // Provider / Model state
        providers: [],
        loadingProviders: false,
        selectedProvider: '',
        models: [],
        loadingModels: false,
        modelSearch: '',
        defaultModel: '',

        getFilteredModels() {
            if (!this.modelSearch) return this.models;
            const q = this.modelSearch.toLowerCase();
            return this.models.filter(m =>
                m.name.toLowerCase().includes(q) || m.id.toLowerCase().includes(q)
            );
        },

        async loadSettings() {
            const res = await fetch('/api/auth/me');
            if (res.ok) this.user = await res.json();
            await this.loadProviders();
            // Restore saved provider/model from localStorage
            const savedProvider = localStorage.getItem('idpkit_provider');
            const savedModel = localStorage.getItem('idpkit_model');
            if (savedProvider) {
                this.selectedProvider = savedProvider;
                await this.fetchModels();
                if (savedModel && this.models.find(x => x.id === savedModel)) {
                    this.defaultModel = savedModel;
                }
            }
        },

        async loadProviders() {
            this.loadingProviders = true;
            try {
                const res = await fetch('/api/settings/providers');
                if (res.ok) {
                    this.providers = await res.json();
                } else {
                    console.error('Failed to load providers:', res.status);
                }
            } catch(e) {
                console.error('Error loading providers:', e);
            } finally {
                this.loadingProviders = false;
            }
        },

        async onProviderChange() {
            this.models = [];
            this.defaultModel = '';
            this.modelSearch = '';
            if (this.selectedProvider) {
                localStorage.setItem('idpkit_provider', this.selectedProvider);
                await this.fetchModels();
            }
        },

        async fetchModels() {
            if (!this.selectedProvider) return;
            this.loadingModels = true;
            try {
                const res = await fetch('/api/settings/models?provider=' + encodeURIComponent(this.selectedProvider));
                if (res.ok) {
                    this.models = await res.json();
                    console.log('Loaded', this.models.length, 'models for', this.selectedProvider);
                } else {
                    console.error('Failed to fetch models:', res.status);
                }
            } catch(e) {
                console.error('Error fetching models:', e);
            } finally {
                this.loadingModels = false;
            }
        },

        selectModel(m) {
            this.defaultModel = m.id;
            localStorage.setItem('idpkit_model', m.id);
        },

        async generateKey() {
            const res = await fetch('/api/auth/apikey', { method: 'POST' });
            if (res.ok) { const data = await res.json(); this.apiKey = data.api_key; }
        }
    }
}
</script>
{% endblock %}
